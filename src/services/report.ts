import { AnalysisModel, CodeIssueModel, LearningResourceModel } from '../models/analysis.js';
import { IssueTypeFormatter, SeverityFormatter, DateFormatter } from '../utils/formatters.js';

export class ReportGenerator {
  generateMarkdownReport(analysis: AnalysisModel): string {
    let report = `# ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæžœ\n\n`;
    report += `**Repository**: ${analysis.repository}\n`;
    report += `**Pull Request**: #${analysis.pullRequestId}\n`;
    report += `**åˆ†æžæ—¥æ™‚**: ${DateFormatter.toJapaneseString(analysis.createdAt)}\n\n`;
    
    report += `## ðŸ“Š ã‚µãƒžãƒªãƒ¼\n${analysis.summary}\n\n`;
    
    if (analysis.totalIssues > 0) {
      report += this.generateIssuesSection(analysis);
    }
    
    if (analysis.suggestions.length > 0) {
      report += this.generateSuggestionsSection(analysis.suggestions);
    }
    
    return report;
  }

  generateJsonReport(analysis: AnalysisModel): object {
    return {
      id: analysis.id,
      repository: analysis.repository,
      pullRequestId: analysis.pullRequestId,
      summary: analysis.summary,
      createdAt: DateFormatter.toISOString(analysis.createdAt),
      statistics: {
        totalIssues: analysis.totalIssues,
        criticalCount: analysis.criticalIssues.length,
        highCount: analysis.highSeverityIssues.length,
        mediumCount: analysis.mediumSeverityIssues.length,
        lowCount: analysis.lowSeverityIssues.length,
        affectedFiles: analysis.affectedFiles.length
      },
      issues: analysis.issues.map(issue => this.formatIssueForJson(issue)),
      suggestions: analysis.suggestions.map(suggestion => this.formatSuggestionForJson(suggestion))
    };
  }

  generateGitHubCommentReport(analysis: AnalysisModel): string {
    let comment = `## ðŸ¤– Code-Mole ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæžœ\n\n`;
    comment += `ðŸ“Š **ã‚µãƒžãƒªãƒ¼**: ${analysis.summary}\n\n`;

    if (analysis.hasCriticalIssues) {
      comment += `âš ï¸ **é‡è¦**: ${analysis.criticalIssues.length}ä»¶ã®é‡å¤§ãªå•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ\n\n`;
    }

    if (analysis.totalIssues > 0) {
      comment += `### ðŸ” æ¤œå‡ºã•ã‚ŒãŸå•é¡Œ (${analysis.totalIssues}ä»¶)\n\n`;
      
      // é‡è¦åº¦ã®é«˜ã„å•é¡Œã®ã¿è¡¨ç¤ºï¼ˆã‚³ãƒ¡ãƒ³ãƒˆãŒé•·ããªã‚Šã™ãŽãªã„ã‚ˆã†ï¼‰
      const highPriorityIssues = analysis.issues
        .filter(issue => issue.isHighPriority)
        .slice(0, 5); // æœ€å¤§5ä»¶ã¾ã§

      highPriorityIssues.forEach((issue, index) => {
        comment += `${index + 1}. **${issue.locationString}** `;
        comment += `(${SeverityFormatter.getDisplayName(issue.severity)})\n`;
        comment += `   ${issue.description}\n`;
        comment += `   ðŸ’¡ ${issue.recommendation}\n\n`;
      });

      if (analysis.issues.length > 5) {
        comment += `... ä»– ${analysis.issues.length - 5} ä»¶ã®å•é¡ŒãŒã‚ã‚Šã¾ã™\n\n`;
      }
    }

    if (analysis.suggestions.length > 0) {
      comment += `### ðŸ“š æŽ¨å¥¨å­¦ç¿’ãƒªã‚½ãƒ¼ã‚¹\n\n`;
      analysis.suggestions.slice(0, 3).forEach((resource, index) => {
        comment += `${index + 1}. [${resource.title}](${resource.url})\n`;
      });
    }

    comment += `\n---\n_Generated by [Code-Mole](https://github.com/HasutoSasaki/code-mole) ðŸ¹_`;
    
    return comment;
  }

  private generateIssuesSection(analysis: AnalysisModel): string {
    let section = `## ðŸ” æ¤œå‡ºã•ã‚ŒãŸå•é¡Œ\n\n`;
    
    Object.entries(analysis.issuesByType).forEach(([type, issues]) => {
      section += `### ${IssueTypeFormatter.getDisplayName(type)}\n`;
      issues.forEach((issue, index) => {
        section += `${index + 1}. **${issue.locationString}** `;
        section += `(${SeverityFormatter.getDisplayName(issue.severity)})\n`;
        section += `   - ${issue.description}\n`;
        section += `   - ðŸ’¡ ${issue.recommendation}\n\n`;
      });
    });
    
    return section;
  }

  private generateSuggestionsSection(suggestions: LearningResourceModel[]): string {
    let section = `## ðŸ“š å­¦ç¿’ãƒªã‚½ãƒ¼ã‚¹\n\n`;
    
    suggestions.forEach((resource, index) => {
      section += `${index + 1}. [${resource.title}](${resource.url})\n`;
      section += `   - ${resource.description}\n`;
      if (resource.tags.length > 0) {
        section += `   - Tags: ${resource.tags.join(', ')}\n`;
      }
      section += `\n`;
    });
    
    return section;
  }

  private formatIssueForJson(issue: CodeIssueModel): object {
    return {
      type: issue.type,
      severity: issue.severity,
      file: issue.file,
      ...(issue.line && { line: issue.line }),
      description: issue.description,
      recommendation: issue.recommendation,
      locationString: issue.locationString,
      isHighPriority: issue.isHighPriority
    };
  }

  private formatSuggestionForJson(suggestion: LearningResourceModel): object {
    return {
      title: suggestion.title,
      url: suggestion.url,
      source: suggestion.source,
      description: suggestion.description,
      ...(suggestion.language && { language: suggestion.language }),
      tags: suggestion.tags,
      isJapanese: suggestion.isJapanese
    };
  }
}